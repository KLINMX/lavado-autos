<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Recibo - AutoWash Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #1e40af;
  --primary-dark: #1e3a8a;
  --success: #059669;
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-500: #6b7280;
  --gray-600: #4b5563;
  --gray-700: #374151;
  --gray-900: #111827;
  --white: #ffffff;
  --radius: 12px;
  --shadow-lg: 0 20px 25px rgba(0,0,0,0.1);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(135deg, var(--gray-50) 0%, var(--white) 50%);
  color: var(--gray-900);
  line-height: 1.6;
  min-height: 100vh;
  padding: 32px 16px;
}

.container {
  max-width: 800px;
  margin: 0 auto;
}

.receipt-card {
  background: var(--white);
  border: 1px solid var(--gray-200);
  border-radius: var(--radius);
  padding: 40px;
  box-shadow: var(--shadow-lg);
}

.receipt-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 32px;
  gap: 20px;
  flex-wrap: wrap;
}

.brand-section {
  display: flex;
  align-items: center;
  gap: 14px;
}

.logo {
  width: 64px;
  height: 64px;
  border-radius: var(--radius);
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 24px;
  color: var(--white);
  box-shadow: 0 4px 12px rgba(30,64,175,0.3);
}

.brand-info h1 {
  font-size: 1.4rem;
  font-weight: 700;
  margin-bottom: 4px;
}

.receipt-id {
  font-size: 0.9rem;
  color: var(--gray-500);
  font-weight: 500;
}

.date-section {
  text-align: right;
}

.date-label {
  font-size: 0.85rem;
  color: var(--gray-500);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 500;
}

.date-value {
  font-size: 1rem;
  font-weight: 600;
  color: var(--gray-900);
  margin-top: 4px;
}

.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 600;
  background: #d1fae5;
  color: var(--success);
  margin-top: 8px;
}

.divider {
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--gray-200), transparent);
  margin: 24px 0;
}

.info-section {
  margin-bottom: 24px;
}

.section-title {
  font-size: 0.85rem;
  color: var(--gray-500);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
  margin-bottom: 16px;
}

.info-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  gap: 16px;
}

.info-label {
  color: var(--gray-600);
  font-size: 0.95rem;
  font-weight: 500;
}

.info-value {
  font-weight: 600;
  color: var(--gray-900);
  text-align: right;
}

.total-row {
  background: linear-gradient(135deg, var(--gray-50), var(--white));
  border: 2px solid var(--primary);
  border-radius: var(--radius);
  padding: 20px;
  margin: 24px 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.total-label {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--gray-700);
}

.total-value {
  font-size: 2rem;
  font-weight: 900;
  color: var(--primary);
}

.qr-section {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 24px;
  margin: 32px 0;
  flex-wrap: wrap;
}

.code-info {
  flex: 1;
}

.code-label {
  font-size: 0.85rem;
  color: var(--gray-500);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
  margin-bottom: 8px;
}

.code-value {
  font-size: 1.8rem;
  font-weight: 800;
  color: var(--gray-900);
  font-family: 'Courier New', monospace;
  letter-spacing: 2px;
}

.qr-container {
  width: 180px;
  height: 180px;
  background: var(--white);
  border: 2px solid var(--gray-200);
  border-radius: var(--radius);
  padding: 12px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.07);
}

.qr-container img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

.actions-section {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin: 28px 0;
}

.btn {
  padding: 12px 24px;
  border: none;
  border-radius: var(--radius);
  font-weight: 600;
  font-size: 0.95rem;
  cursor: pointer;
  transition: all 0.3s;
  font-family: inherit;
  flex: 1;
  min-width: 140px;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: var(--white);
  box-shadow: 0 4px 6px rgba(30,64,175,0.2);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 12px rgba(30,64,175,0.3);
}

.btn-secondary {
  background: var(--white);
  border: 2px solid var(--gray-200);
  color: var(--gray-700);
}

.btn-secondary:hover {
  background: var(--gray-50);
}

.footer-note {
  text-align: center;
  color: var(--gray-500);
  font-size: 0.9rem;
  line-height: 1.6;
  padding: 20px;
  background: var(--gray-50);
  border-radius: var(--radius);
  border: 1px solid var(--gray-200);
}

.loading {
  text-align: center;
  padding: 80px 20px;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 4px solid var(--gray-200);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 0 auto 20px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.error-state {
  text-align: center;
  padding: 60px 20px;
}

.error-icon {
  font-size: 4rem;
  margin-bottom: 20px;
  opacity: 0.5;
}

.error-title {
  font-size: 1.5rem;
  font-weight: 700;
  margin-bottom: 12px;
}

@media (max-width: 768px) {
  .receipt-card {
    padding: 28px 20px;
  }
  
  .receipt-header {
    flex-direction: column;
  }
  
  .date-section {
    text-align: left;
    width: 100%;
  }
  
  .qr-section {
    flex-direction: column-reverse;
    align-items: center;
  }
  
  .code-info {
    text-align: center;
  }
  
  .actions-section {
    flex-direction: column;
  }
  
  .btn {
    width: 100%;
  }
}

@media print {
  body {
    background: white;
    padding: 0;
  }
  
  .actions-section {
    display: none;
  }
  
  .receipt-card {
    box-shadow: none;
    border: 1px solid #000;
  }
}
</style>
</head>
<body>

<div class="container">
  <div id="loadingState" class="receipt-card loading">
    <div class="spinner"></div>
    <div style="color: var(--gray-600); font-weight: 500;">Cargando recibo...</div>
  </div>

  <div id="errorState" class="receipt-card error-state" style="display: none;">
    <div class="error-icon">ðŸ”­</div>
    <h2 class="error-title">Recibo No Encontrado</h2>
    <p style="color: var(--gray-600);">No pudimos encontrar la informaciÃ³n de esta reservaciÃ³n.</p>
    <div style="margin-top: 24px;">
      <button class="btn btn-primary" onclick="window.location.href='index.html'">
        Ir a Inicio
      </button>
    </div>
  </div>

  <div id="receiptContent" class="receipt-card" style="display: none;">
    <div class="receipt-header">
      <div class="brand-section">
        <div class="logo">AW</div>
        <div class="brand-info">
          <h1 id="businessName">AutoWash Pro</h1>
          <div class="receipt-id" id="receiptId">Recibo #â€”</div>
        </div>
      </div>
      <div class="date-section">
        <div class="date-label">Fecha de Reserva</div>
        <div class="date-value" id="receiptDate">â€”</div>
        <div class="date-value" id="receiptTime">â€”</div>
        <div class="status-badge" id="statusBadge">
          âœ“ Confirmada
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="info-section">
      <h2 class="section-title">InformaciÃ³n del Cliente</h2>
      <div class="info-row">
        <span class="info-label">Nombre Completo</span>
        <span class="info-value" id="customerName">â€”</span>
      </div>
      <div class="info-row">
        <span class="info-label">TelÃ©fono</span>
        <span class="info-value" id="customerPhone">â€”</span>
      </div>
      <div class="info-row">
        <span class="info-label">DirecciÃ³n</span>
        <span class="info-value" id="customerAddress">â€”</span>
      </div>
      <div class="info-row">
        <span class="info-label">VehÃ­culo</span>
        <span class="info-value" id="customerCar">â€”</span>
      </div>
    </div>

    <div class="divider"></div>

    <div class="info-section">
      <h2 class="section-title">Detalles del Servicio</h2>
      <div class="info-row">
        <span class="info-label">Servicio</span>
        <span class="info-value" id="serviceName">â€”</span>
      </div>
      <div class="info-row">
        <span class="info-label">DuraciÃ³n Estimada</span>
        <span class="info-value" id="serviceDuration">â€” min</span>
      </div>
    </div>

    <div class="total-row">
      <span class="total-label">Total a Pagar</span>
      <span class="total-value" id="totalPrice">$0</span>
    </div>

    <div class="qr-section" id="qrSection">
      <div class="code-info">
        <div class="code-label">CÃ³digo de VerificaciÃ³n</div>
        <div class="code-value" id="verificationCode">â€”</div>
      </div>
      <div class="qr-container">
        <img id="qrImage" src="" alt="CÃ³digo QR del recibo">
      </div>
    </div>

    <div class="actions-section">
      <button class="btn btn-primary" onclick="window.print()">
        ðŸ“„ Imprimir
      </button>
      <button class="btn btn-secondary" onclick="copyLink()">
        ðŸ”— Copiar Enlace
      </button>
      <button class="btn btn-secondary" onclick="shareWhatsApp()">
        ðŸ’¬ Compartir
      </button>
    </div>

    <div class="footer-note" id="footerNote">
      <strong>Â¡Gracias por tu preferencia!</strong><br>
      Conserva este recibo como comprobante de tu reservaciÃ³n.<br>
      Para cualquier consulta o cambio, contÃ¡ctanos con tu cÃ³digo de verificaciÃ³n.
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
'use strict';

const firebaseConfig = {
  apiKey: "AIzaSyClriIvCnIc9ZgJrw08YNsfxtnECrQ6OFE",
  authDomain: "kl-n-12f7b.firebaseapp.com",
  databaseURL: "https://kl-n-12f7b-default-rtdb.firebaseio.com",
  projectId: "kl-n-12f7b",
  storageBucket: "kl-n-12f7b.firebasestorage.app",
  messagingSenderId: "941333228893",
  appId: "1:941333228893:web:3bbdb9ad91475ed3a2ccb4"
};

let app, database;
const state = { booking: null, settings: {} };

const $ = id => document.getElementById(id);
const getParam = name => new URL(location.href).searchParams.get(name);

function formatDate(dateStr) {
  const date = new Date(dateStr + 'T00:00:00');
  return date.toLocaleDateString('es-MX', {
    weekday: 'long',
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });
}

async function init() {
  try {
    app = firebase.initializeApp(firebaseConfig);
    database = firebase.database();

    const bookingId = getParam('id');
    if (!bookingId) {
      showError();
      return;
    }

    // Load settings
    const settingsSnap = await database.ref('settings').once('value');
    state.settings = settingsSnap.val() || {};
    applySettings();

    // Load booking
    const bookingSnap = await database.ref('bookings/' + bookingId).once('value');
    
    if (!bookingSnap.exists()) {
      showError();
      return;
    }

    state.booking = bookingSnap.val();
    renderReceipt();

  } catch (error) {
    console.error('Error:', error);
    showError();
  }
}

function applySettings() {
  const s = state.settings;
  if (s.businessName) $('businessName').textContent = s.businessName;
  if (s.colorPrimary) {
    document.documentElement.style.setProperty('--primary', s.colorPrimary);
  }
  if (s.textReceiptFooter) {
    $('footerNote').innerHTML = s.textReceiptFooter.replace(/\n/g, '<br>');
  }
}

function showError() {
  $('loadingState').style.display = 'none';
  $('errorState').style.display = '';
}

function renderReceipt() {
  const b = state.booking;
  
  $('loadingState').style.display = 'none';
  $('receiptContent').style.display = '';

  // Header
  $('receiptId').textContent = `Recibo #${(b.id || '').slice(-8).toUpperCase()}`;
  $('receiptDate').textContent = formatDate(b.date);
  $('receiptTime').textContent = b.time || 'â€”';

  // Status
  const statusBadge = $('statusBadge');
  if (b.status === 'confirmed') {
    statusBadge.textContent = 'âœ“ Confirmada';
    statusBadge.style.background = '#d1fae5';
    statusBadge.style.color = '#059669';
  } else {
    statusBadge.textContent = 'âœ— Cancelada';
    statusBadge.style.background = '#fee2e2';
    statusBadge.style.color = '#dc2626';
  }

  // Customer
  $('customerName').textContent = b.name || 'â€”';
  $('customerPhone').textContent = b.phone || 'â€”';
  $('customerAddress').textContent = b.address || 'â€”';
  $('customerCar').textContent = b.car || 'â€”';

  // Service
  $('serviceName').textContent = b.service || 'â€”';
  $('serviceDuration').textContent = (b.duration || 'â€”') + ' min';
  $('totalPrice').textContent = '$' + (b.price || 0);

  // Verification Code
  const code = 'AWP-' + (b.id || '').slice(-6).toUpperCase();
  $('verificationCode').textContent = code;

  // QR Code
  if (state.settings.enableQR !== false) {
    const receiptUrl = location.href;
    const qrUrl = `https://chart.googleapis.com/chart?cht=qr&chs=400x400&chl=${encodeURIComponent(receiptUrl)}`;
    $('qrImage').src = qrUrl;
  } else {
    $('qrSection').style.display = 'none';
  }
}

function copyLink() {
  navigator.clipboard.writeText(location.href)
    .then(() => alert('âœ“ Enlace copiado al portapapeles'))
    .catch(() => alert('No se pudo copiar el enlace'));
}

function shareWhatsApp() {
  const b = state.booking;
  const message = `Â¡ReservaciÃ³n confirmada! ðŸš—\n\nServicio: ${b.service}\nFecha: ${formatDate(b.date)}\nHora: ${b.time}\nTotal: $${b.price}\n\nVer recibo: ${location.href}`;
  const phone = state.settings.whatsappPhone || '';
  const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
  window.open(url, '_blank');
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
