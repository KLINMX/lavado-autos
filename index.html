<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AutoWash Pro | Reserva tu Servicio</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #1e40af;
  --primary-dark: #1e3a8a;
  --success: #059669;
  --danger: #dc2626;
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-300: #d1d5db;
  --gray-500: #6b7280;
  --gray-600: #4b5563;
  --gray-700: #374151;
  --gray-900: #111827;
  --white: #ffffff;
  --radius: 12px;
  --shadow: 0 4px 6px rgba(0,0,0,0.07);
  --shadow-lg: 0 20px 25px rgba(0,0,0,0.1);
  --transition: cubic-bezier(0.4, 0, 0.2, 1);
}

* { box-sizing: border-box; margin: 0; padding: 0; }

html {
  scroll-behavior: smooth;
  -webkit-font-smoothing: antialiased;
}

body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(135deg, var(--gray-50) 0%, var(--white) 50%);
  color: var(--gray-900);
  line-height: 1.6;
  min-height: 100vh;
  padding-bottom: 120px;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

/* Header */
.header {
  background: var(--white);
  border-radius: var(--radius);
  padding: 20px;
  box-shadow: var(--shadow);
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  gap: 16px;
  flex-wrap: wrap;
}

.brand {
  display: flex;
  align-items: center;
  gap: 14px;
}

.logo {
  width: 56px;
  height: 56px;
  border-radius: var(--radius);
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 20px;
  color: var(--white);
  box-shadow: 0 4px 12px rgba(30,64,175,0.3);
}

.brand-text h1 {
  font-size: 1.3rem;
  font-weight: 800;
  color: var(--gray-900);
}

.brand-text .subtitle {
  font-size: 0.9rem;
  color: var(--gray-500);
}

.btn {
  padding: 12px 24px;
  border: none;
  border-radius: var(--radius);
  font-weight: 600;
  font-size: 0.95rem;
  cursor: pointer;
  transition: all 0.3s var(--transition);
  font-family: inherit;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: var(--white);
  box-shadow: 0 4px 6px rgba(30,64,175,0.2);
}

.btn-primary:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 8px 12px rgba(30,64,175,0.3);
}

.btn-secondary {
  background: var(--white);
  border: 2px solid var(--gray-300);
  color: var(--gray-700);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Layout */
.layout {
  display: grid;
  gap: 24px;
}

@media (min-width: 1024px) {
  .layout {
    grid-template-columns: 1fr 360px;
  }
}

/* Card */
.card {
  background: var(--white);
  border-radius: var(--radius);
  padding: 28px;
  box-shadow: var(--shadow);
  margin-bottom: 24px;
  min-height: 400px;
  display: flex;
  flex-direction: column;
}

.step-header {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 24px;
}

.step-number {
  width: 48px;
  height: 48px;
  border-radius: var(--radius);
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 1.3rem;
  color: var(--white);
  box-shadow: 0 4px 8px rgba(30,64,175,0.2);
}

.step-content h2 {
  font-size: 1.4rem;
  font-weight: 700;
  margin-bottom: 4px;
}

.step-content .lead {
  color: var(--gray-500);
  font-size: 0.95rem;
}

/* Services */
.services-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
  flex: 1;
}

.service-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 24px;
  background: var(--white);
  border: 3px solid var(--gray-200);
  border-radius: var(--radius);
  cursor: pointer;
  transition: all 0.3s var(--transition);
  text-align: center;
  min-height: 220px;
}

.service-card:hover {
  transform: translateY(-4px);
  border-color: var(--primary);
  box-shadow: var(--shadow-lg);
}

.service-card.selected {
  border-color: var(--primary);
  background: linear-gradient(135deg, rgba(30,64,175,0.05), var(--white));
  box-shadow: 0 8px 16px rgba(30,64,175,0.15);
}

.service-icon {
  font-size: 3rem;
  margin-bottom: 12px;
}

.service-name {
  font-weight: 700;
  font-size: 1.2rem;
  margin-bottom: 8px;
}

.service-desc {
  font-size: 0.9rem;
  color: var(--gray-600);
  margin-bottom: 12px;
  flex: 1;
}

.service-price {
  font-weight: 800;
  font-size: 1.6rem;
  color: var(--primary);
  margin-top: 8px;
}

.service-time {
  font-size: 0.85rem;
  color: var(--gray-500);
  margin-top: 4px;
}

/* Date Time Selectors */
.selector-group {
  display: grid;
  gap: 16px;
  margin-top: 20px;
  flex: 1;
}

.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--gray-700);
  font-size: 0.95rem;
}

.form-control, .form-select {
  width: 100%;
  padding: 14px 16px;
  background: var(--white);
  border: 2px solid var(--gray-300);
  border-radius: var(--radius);
  color: var(--gray-900);
  font-size: 1rem;
  font-family: inherit;
  transition: all 0.3s var(--transition);
  font-weight: 500;
}

.form-control:focus, .form-select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 4px rgba(30,64,175,0.1);
}

.form-select {
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23374151'%3E%3Cpath d='M4 6l4 4 4-4'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 40px;
}

.availability-info {
  margin-top: 12px;
  padding: 12px;
  background: var(--gray-50);
  border-radius: 8px;
  font-size: 0.9rem;
  color: var(--gray-700);
  text-align: center;
}

/* Form */
.booking-form {
  display: grid;
  gap: 20px;
  flex: 1;
}

/* Summary */
.summary-card {
  position: sticky;
  top: 20px;
  background: linear-gradient(135deg, rgba(30,64,175,0.05), var(--white));
  border: 2px solid var(--primary);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: var(--shadow);
}

.summary-header {
  font-size: 1.2rem;
  font-weight: 700;
  margin-bottom: 20px;
}

.summary-row {
  display: flex;
  justify-content: space-between;
  padding: 12px 0;
  gap: 16px;
}

.summary-label {
  color: var(--gray-600);
  font-size: 0.95rem;
}

.summary-value {
  font-weight: 700;
  color: var(--gray-900);
  text-align: right;
}

.summary-divider {
  height: 1px;
  background: var(--gray-300);
  margin: 12px 0;
}

.summary-total {
  font-size: 2rem;
  font-weight: 900;
  color: var(--primary);
}

/* Actions */
.card-actions {
  display: flex;
  gap: 12px;
  margin-top: auto;
  padding-top: 24px;
}

/* Modal */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(4px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: var(--white);
  border-radius: var(--radius);
  padding: 36px;
  max-width: 500px;
  width: 100%;
  text-align: center;
  box-shadow: var(--shadow-lg);
}

.success-icon {
  width: 80px;
  height: 80px;
  margin: 0 auto 24px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--success), #047857);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  color: var(--white);
  box-shadow: 0 8px 20px rgba(5,150,105,0.3);
}

.modal-title {
  font-size: 1.6rem;
  font-weight: 700;
  margin-bottom: 12px;
}

.modal-text {
  color: var(--gray-600);
  margin-bottom: 28px;
  line-height: 1.6;
}

.modal-actions {
  display: flex;
  gap: 12px;
  justify-content: center;
  flex-wrap: wrap;
}

/* Mobile Bottom Bar */
.mobile-summary {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--white);
  border-top: 2px solid var(--gray-200);
  padding: 16px 20px;
  display: none;
  justify-content: space-between;
  align-items: center;
  z-index: 100;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
}

@media (max-width: 1023px) {
  .summary-card {
    display: none;
  }
  
  .mobile-summary {
    display: flex;
  }
}

/* Responsive */
@media (max-width: 768px) {
  .services-grid {
    grid-template-columns: 1fr;
  }
  
  .card {
    padding: 20px;
    min-height: 350px;
  }
}

/* Loading */
.loading {
  text-align: center;
  padding: 40px;
  color: var(--gray-500);
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid var(--gray-200);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 0 auto 16px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
</head>
<body>

<div class="container">
  <!-- Header -->
  <header class="header">
    <div class="brand">
      <div class="logo" id="headerLogo">AW</div>
      <div class="brand-text">
        <h1 id="headerTitle">AutoWash Pro</h1>
        <p class="subtitle" id="headerSubtitle">Sistema de Reservas Premium</p>
      </div>
    </div>
    <button class="btn btn-secondary" onclick="window.location.href='admin.html'">Admin</button>
  </header>

  <!-- Main Layout -->
  <div class="layout">
    <main>
      <!-- Step 1: Service -->
      <div class="card">
        <div class="step-header">
          <div class="step-number">1</div>
          <div class="step-content">
            <h2>Selecciona tu Servicio</h2>
            <p class="lead">Elige el paquete perfecto para tu veh√≠culo</p>
          </div>
        </div>
        <div id="servicesContainer" class="services-grid">
          <div class="loading">
            <div class="spinner"></div>
            <div>Cargando servicios...</div>
          </div>
        </div>
      </div>

      <!-- Step 2: Date & Time -->
      <div class="card" id="step2" style="display: none;">
        <div class="step-header">
          <div class="step-number">2</div>
          <div class="step-content">
            <h2>Fecha y Horario</h2>
            <p class="lead">Selecciona cu√°ndo quieres tu servicio</p>
          </div>
        </div>
        
        <div class="selector-group">
          <div class="form-group">
            <label class="form-label">üìÖ Fecha</label>
            <select id="dateSelect" class="form-select">
              <option value="">Selecciona una fecha...</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">‚è∞ Hora</label>
            <select id="timeSelect" class="form-select" disabled>
              <option value="">Primero selecciona una fecha</option>
            </select>
          </div>

          <div id="availabilityInfo" class="availability-info" style="display: none;"></div>
        </div>

        <div class="card-actions">
          <button class="btn btn-secondary" onclick="goToStep(1)" style="flex: 1;">‚Üê Volver</button>
          <button class="btn btn-primary" id="continueToStep3" style="flex: 2;" disabled>Continuar ‚Üí</button>
        </div>
      </div>

      <!-- Step 3: Contact Info -->
      <div class="card" id="step3" style="display: none;">
        <div class="step-header">
          <div class="step-number">3</div>
          <div class="step-content">
            <h2>Informaci√≥n de Contacto</h2>
            <p class="lead">Solo lo esencial para confirmar tu cita</p>
          </div>
        </div>

        <form class="booking-form" id="bookingForm">
          <div class="form-group">
            <label class="form-label">Nombre Completo</label>
            <input type="text" id="customerName" class="form-control" placeholder="Juan P√©rez Garc√≠a" required>
          </div>

          <div class="form-group">
            <label class="form-label">Tel√©fono</label>
            <input type="tel" id="customerPhone" class="form-control" placeholder="4611234567" required>
          </div>

          <div class="form-group">
            <label class="form-label">Direcci√≥n</label>
            <input type="text" id="customerAddress" class="form-control" placeholder="Av. Ju√°rez #123, Col. Centro" required>
          </div>

          <div class="form-group">
            <label class="form-label">Veh√≠culo</label>
            <input type="text" id="customerCar" class="form-control" placeholder="Toyota Corolla 2020 - Blanco" required>
          </div>

          <div class="card-actions">
            <button type="button" class="btn btn-secondary" onclick="goToStep(2)" style="flex: 1;">‚Üê Volver</button>
            <button type="submit" class="btn btn-primary" id="submitBtn" style="flex: 2;">‚úì Confirmar Reservaci√≥n</button>
          </div>
        </form>
      </div>
    </main>

    <!-- Summary Sidebar -->
    <aside>
      <div class="summary-card">
        <h3 class="summary-header">Resumen de Reserva</h3>
        <div class="summary-row">
          <span class="summary-label">Servicio</span>
          <span class="summary-value" id="summaryService">‚Äî</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Duraci√≥n</span>
          <span class="summary-value" id="summaryDuration">‚Äî min</span>
        </div>
        <div class="summary-divider"></div>
        <div class="summary-row">
          <span class="summary-label">Fecha</span>
          <span class="summary-value" id="summaryDate">‚Äî</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Hora</span>
          <span class="summary-value" id="summaryTime">‚Äî</span>
        </div>
        <div class="summary-divider"></div>
        <div class="summary-row">
          <span class="summary-label">Total a Pagar</span>
          <span class="summary-total" id="summaryTotal">$0</span>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- Mobile Summary -->
<div class="mobile-summary">
  <div>
    <div style="font-weight: 700; margin-bottom: 4px;" id="mobileService">‚Äî</div>
    <div style="font-size: 0.9rem; color: var(--gray-500);" id="mobileDateTime">‚Äî</div>
  </div>
  <div style="text-align: right;">
    <div style="font-weight: 800; font-size: 1.3rem; color: var(--primary);" id="mobilePrice">$0</div>
  </div>
</div>

<!-- Success Modal -->
<div class="modal" id="successModal">
  <div class="modal-content">
    <div class="success-icon">‚úì</div>
    <h3 class="modal-title">¬°Reservaci√≥n Confirmada!</h3>
    <p class="modal-text" id="modalText">Tu cita ha sido registrada exitosamente</p>
    
    <div style="margin: 24px 0; padding: 16px; background: var(--gray-50); border-radius: 8px;">
      <p style="font-size: 0.9rem; color: var(--gray-600); margin-bottom: 8px;">
        üìÑ Guarda tu comprobante:
      </p>
      <p style="font-size: 0.85rem; color: var(--gray-500); margin-bottom: 12px;" id="receiptUrl"></p>
    </div>
    
    <div class="modal-actions">
      <button class="btn btn-primary" id="viewReceiptBtn">Ver Recibo</button>
      <button class="btn btn-secondary" id="shareReceiptBtn">üì± Compartir</button>
      <button class="btn btn-secondary" id="newBookingBtn">Nueva Reserva</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
'use strict';

const firebaseConfig = {
  apiKey: "AIzaSyClriIvCnIc9ZgJrw08YNsfxtnECrQ6OFE",
  authDomain: "kl-n-12f7b.firebaseapp.com",
  databaseURL: "https://kl-n-12f7b-default-rtdb.firebaseio.com",
  projectId: "kl-n-12f7b",
  storageBucket: "kl-n-12f7b.firebasestorage.app",
  messagingSenderId: "941333228893",
  appId: "1:941333228893:web:3bbdb9ad91475ed3a2ccb4"
};

let app, database;
const state = {
  services: [],
  schedules: {},
  bookings: [],
  settings: {},
  selectedService: null,
  selectedDate: null,
  selectedTime: null,
  lastBookingId: null
};

const $ = id => document.getElementById(id);

function init() {
  app = firebase.initializeApp(firebaseConfig);
  database = firebase.database();

  loadData();
  setupEventListeners();
}

function loadData() {
  database.ref('services').on('value', snap => {
    state.services = snap.val() ? Object.values(snap.val()) : [];
    renderServices();
  });

  database.ref('schedules').on('value', snap => {
    state.schedules = snap.val() || {};
    renderDates();
  });

  database.ref('bookings').on('value', snap => {
    state.bookings = snap.val() ? Object.values(snap.val()) : [];
  });

  database.ref('settings').on('value', snap => {
    state.settings = snap.val() || {};
    applySettings();
  });
}

function applySettings() {
  const s = state.settings;
  if (s.businessName) $('headerTitle').textContent = s.businessName;
  if (s.businessSubtitle) $('headerSubtitle').textContent = s.businessSubtitle;
  if (s.colorPrimary) {
    document.documentElement.style.setProperty('--primary', s.colorPrimary);
  }
}

function setupEventListeners() {
  $('dateSelect').addEventListener('change', handleDateChange);
  $('timeSelect').addEventListener('change', handleTimeChange);
  $('continueToStep3').addEventListener('click', () => goToStep(3));
  $('bookingForm').addEventListener('submit', handleSubmit);
  $('newBookingBtn').addEventListener('click', resetFlow);
  $('viewReceiptBtn').addEventListener('click', openReceipt);
  $('shareReceiptBtn').addEventListener('click', shareReceipt);
  $('customerPhone').addEventListener('input', e => {
    e.target.value = e.target.value.replace(/\D/g, '');
  });
}

function renderServices() {
  const container = $('servicesContainer');
  
  if (!state.services.length) {
    container.innerHTML = '<div class="loading">No hay servicios disponibles</div>';
    return;
  }

  container.innerHTML = state.services.map(s => `
    <div class="service-card" onclick="selectService(${s.id})">
      <div class="service-icon">${s.icon || 'üöó'}</div>
      <div class="service-name">${s.name}</div>
      <div class="service-desc">${s.description}</div>
      <div class="service-price">$${s.price}</div>
      <div class="service-time">‚è± ${s.time} min</div>
    </div>
  `).join('');
}

window.selectService = function(id) {
  const service = state.services.find(s => s.id === id);
  if (!service) return;

  state.selectedService = service;

  document.querySelectorAll('.service-card').forEach(card => {
    card.classList.remove('selected');
  });
  event.currentTarget.classList.add('selected');

  updateSummary();
  goToStep(2);
};

function renderDates() {
  const select = $('dateSelect');
  const days = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
  const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
  
  let html = '<option value="">Selecciona una fecha...</option>';

  for (let i = 0; i < 30; i++) {
    const date = new Date();
    date.setDate(date.getDate() + i);
    const dayOfWeek = date.getDay();
    const dateStr = date.toISOString().split('T')[0];
    
    const schedule = state.schedules[dayOfWeek];
    if (schedule && schedule.active) {
      const formatted = `${days[dayOfWeek]} ${date.getDate()}/${months[date.getMonth()]}`;
      html += `<option value="${dateStr}">${formatted}</option>`;
    }
  }

  select.innerHTML = html;
}

function handleDateChange() {
  const date = $('dateSelect').value;
  if (!date) {
    $('timeSelect').disabled = true;
    $('timeSelect').innerHTML = '<option value="">Primero selecciona una fecha</option>';
    return;
  }

  state.selectedDate = date;
  renderTimes();
  updateSummary();
  $('continueToStep3').disabled = !state.selectedTime;
}

function renderTimes() {
  const select = $('timeSelect');
  const date = new Date(state.selectedDate + 'T00:00');
  const dayOfWeek = date.getDay();
  const schedule = state.schedules[dayOfWeek];

  if (!schedule || !schedule.active) {
    select.innerHTML = '<option value="">No hay horarios disponibles</option>';
    select.disabled = true;
    return;
  }

  const times = generateTimeSlots(schedule.start, schedule.end);
  let html = '<option value="">Selecciona un horario...</option>';

  times.forEach(time => {
    const available = isTimeAvailable(state.selectedDate, time);
    if (available) {
      html += `<option value="${time}">${time}</option>`;
    } else {
      html += `<option value="${time}" disabled>${time} (Ocupado)</option>`;
    }
  });

  select.innerHTML = html;
  select.disabled = false;

  updateAvailability();
}

function generateTimeSlots(start, end) {
  const slots = [];
  const [startH, startM] = start.split(':').map(Number);
  const [endH, endM] = end.split(':').map(Number);
  
  let current = startH * 60 + startM;
  const endMin = endH * 60 + endM;

  while (current + 30 <= endMin) {
    const h = Math.floor(current / 60);
    const m = current % 60;
    slots.push(`${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`);
    current += 30;
  }

  return slots;
}

function isTimeAvailable(date, time) {
  if (!state.selectedService) return false;

  const requestStart = new Date(`${date}T${time}`);
  const requestEnd = new Date(requestStart.getTime() + state.selectedService.time * 60000);

  // No permitir reservas en el pasado
  if (requestStart < new Date()) return false;

  // Verificar si hay conflicto con otras reservas
  return !state.bookings.some(b => {
    if (b.status === 'cancelled' || b.date !== date) return false;
    
    const bookingStart = new Date(`${b.date}T${b.time}`);
    const bookingEnd = new Date(bookingStart.getTime() + (b.duration || 30) * 60000);
    
    // Hay conflicto si los rangos se superponen
    // Nueva reserva empieza antes de que termine la existente
    // Y nueva reserva termina despu√©s de que comienza la existente
    return (requestStart < bookingEnd && requestEnd > bookingStart);
  });
}

function updateAvailability() {
  const info = $('availabilityInfo');
  const times = Array.from($('timeSelect').options).filter(o => o.value && !o.disabled);
  
  if (times.length > 0) {
    info.textContent = `‚úì ${times.length} horarios disponibles`;
    info.style.display = 'block';
  } else {
    info.textContent = '‚úó No hay horarios disponibles para este d√≠a';
    info.style.display = 'block';
  }
}

function handleTimeChange() {
  state.selectedTime = $('timeSelect').value;
  updateSummary();
  $('continueToStep3').disabled = !state.selectedTime;
}

function updateSummary() {
  const s = state.selectedService;
  const date = state.selectedDate;
  const time = state.selectedTime;

  $('summaryService').textContent = s ? s.name : '‚Äî';
  $('summaryDuration').textContent = s ? `${s.time} min` : '‚Äî min';
  $('summaryDate').textContent = date ? formatDate(date) : '‚Äî';
  $('summaryTime').textContent = time || '‚Äî';
  $('summaryTotal').textContent = s ? `${s.price}` : '$0';

  // Mobile summary
  $('mobileService').textContent = s ? s.name : '‚Äî';
  $('mobileDateTime').textContent = (date && time) ? `${formatDate(date)} ‚Ä¢ ${time}` : '‚Äî';
  $('mobilePrice').textContent = s ? `${s.price}` : '$0';
}

function formatDate(dateStr) {
  const date = new Date(dateStr + 'T00:00');
  const days = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
  const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
  
  return `${days[date.getDay()]} ${date.getDate()}/${months[date.getMonth()]}`;
}

function goToStep(step) {
  $('step2').style.display = 'none';
  $('step3').style.display = 'none';

  if (step === 2) {
    $('step2').style.display = '';
    setTimeout(() => $('step2').scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
  } else if (step === 3) {
    $('step3').style.display = '';
    setTimeout(() => $('step3').scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
  }
}

async function handleSubmit(e) {
  e.preventDefault();

  const name = $('customerName').value.trim();
  const phone = $('customerPhone').value.replace(/\D/g, '');
  const address = $('customerAddress').value.trim();
  const car = $('customerCar').value.trim();

  if (!name || name.length < 2) {
    alert('‚ö†Ô∏è Por favor ingresa tu nombre completo');
    return;
  }

  if (!/^[0-9]{10,15}$/.test(phone)) {
    alert('‚ö†Ô∏è Por favor ingresa un tel√©fono v√°lido (10-15 d√≠gitos)');
    return;
  }

  if (!address || address.length < 5) {
    alert('‚ö†Ô∏è Por favor ingresa tu direcci√≥n completa');
    return;
  }

  if (!car || car.length < 3) {
    alert('‚ö†Ô∏è Por favor ingresa los datos de tu veh√≠culo');
    return;
  }

  if (!state.selectedService || !state.selectedDate || !state.selectedTime) {
    alert('‚ö†Ô∏è Por favor completa todos los pasos');
    return;
  }

  const submitBtn = $('submitBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Procesando...';

  const booking = {
    service: state.selectedService.name,
    price: state.selectedService.price,
    duration: state.selectedService.time,
    date: state.selectedDate,
    time: state.selectedTime,
    name,
    phone,
    address,
    car,
    status: 'confirmed',
    createdAt: new Date().toISOString()
  };

  try {
    const ref = database.ref('bookings').push();
    booking.id = ref.key;
    await ref.set(booking);

    $('modalText').textContent = `${booking.name} ‚Ä¢ ${formatDate(booking.date)} ‚Ä¢ ${booking.time} ‚Ä¢ ${booking.price}`;
    showModal();

  } catch (error) {
    console.error('Error:', error);
    alert('‚ùå Error al procesar la reserva. Por favor intenta nuevamente.');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = '‚úì Confirmar Reservaci√≥n';
  }
}

function showModal() {
  $('successModal').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function hideModal() {
  $('successModal').classList.remove('active');
  document.body.style.overflow = '';
}

function resetFlow() {
  state.selectedService = null;
  state.selectedDate = null;
  state.selectedTime = null;

  $('bookingForm').reset();
  $('dateSelect').value = '';
  $('timeSelect').value = '';
  $('timeSelect').disabled = true;
  $('continueToStep3').disabled = true;

  document.querySelectorAll('.service-card').forEach(card => {
    card.classList.remove('selected');
  });

  $('step2').style.display = 'none';
  $('step3').style.display = 'none';

  updateSummary();
  hideModal();

  window.scrollTo({ top: 0, behavior: 'smooth' });
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
