<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin — AutoWash Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{--accent:#2563eb;--bg:#071028;--card:rgba(255,255,255,0.02);--text:#e8f0ff;--muted:rgba(255,255,255,0.6);--radius:12px}
body{margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:linear-gradient(180deg,#061024,#071028);color:var(--text)}
.container{max-width:1100px;margin:30px auto;padding:18px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:14px}
.logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#1b4fcf);display:flex;align-items:center;justify-content:center;font-weight:800;color:white}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-bottom:12px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03)}
.btn{padding:8px 10px;border-radius:8px;border:none;background:var(--accent);color:white;cursor:pointer}
.form-row{display:flex;gap:8px;align-items:center}
.login-wrap{max-width:420px;margin:40px auto;padding:18px}
.input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
.small{font-size:0.9rem;color:var(--muted)}
</style>
</head>
<body>
  <div class="container">
    <div id="loginScreen" class="card login-wrap">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px"><div class="logo">AW</div><div><div style="font-weight:800">Admin Panel</div><div class="small">Inicia sesión con tu cuenta</div></div></div>
      <div style="display:grid;gap:10px">
        <input id="email" class="input" placeholder="admin@ejemplo.com" type="email" autocomplete="email">
        <input id="password" class="input" placeholder="Contraseña" type="password" autocomplete="current-password">
        <div style="display:flex;gap:8px"><button id="loginBtn" class="btn">Iniciar sesión</button><button id="demoBtn" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.04)">Volver</button></div>
        <div id="loginMsg" class="small" style="color:var(--muted)"></div>
      </div>
    </div>

    <div id="appScreen" style="display:none">
      <div class="header card"><div style="display:flex;gap:12px;align-items:center"><div class="logo">AW</div><div><div style="font-weight:800">AutoWash — Admin</div><div class="small">Control completo</div></div></div><div style="display:flex;gap:8px;align-items:center"><button id="logoutBtn" class="btn">Cerrar sesión</button></div></div>

      <div class="grid">
        <div class="card"><div class="small">Total reservaciones</div><div id="statTotal" style="font-weight:800;font-size:1.4rem">0</div></div>
        <div class="card"><div class="small">Hoy</div><div id="statToday" style="font-weight:800;font-size:1.4rem">0</div></div>
        <div class="card"><div class="small">Ingresos</div><div id="statRevenue" style="font-weight:800;font-size:1.4rem">$0</div></div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><div style="font-weight:800">Reservaciones recientes</div><div><input id="search" class="input" placeholder="Buscar cliente/teléfono/servicio" style="width:220px"></div></div>
        <div style="overflow:auto"><table class="table" id="bookingsTable"><thead><tr><th>Fecha</th><th>Hora</th><th>Cliente</th><th>Servicio</th><th>Precio</th><th>Estado</th><th>Acción</th></tr></thead><tbody id="tbody"><tr><td colspan="7" style="padding:18px;color:var(--muted)">Cargando...</td></tr></tbody></table></div>
      </div>
    </div>
  </div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
'use strict';
const firebaseConfig = {
  apiKey: "AIzaSyClriIvCnIc9ZgJrw08YNsfxtnECrQ6OFE",
  authDomain: "kl-n-12f7b.firebaseapp.com",
  databaseURL: "https://kl-n-12f7b-default-rtdb.firebaseio.com",
  projectId: "kl-n-12f7b",
  storageBucket: "kl-n-12f7b.firebasestorage.app",
  messagingSenderId: "941333228893",
  appId: "1:941333228893:web:3bbdb9ad91475ed3a2ccb4"
};

let app, auth, database;
function $(id){return document.getElementById(id)}

/* Init */
function init(){
  app = firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  database = firebase.database();

  // auth state
  auth.onAuthStateChanged(user => {
    if(user){
      $('loginScreen').style.display='none';
      $('appScreen').style.display='';
      loadBookings();
    } else {
      $('loginScreen').style.display='block';
      $('appScreen').style.display='none';
    }
  });

  $('loginBtn').addEventListener('click', login);
  $('logoutBtn').addEventListener('click', ()=> auth.signOut());
  $('demoBtn').addEventListener('click', ()=> window.location.href='index.html');
  $('search').addEventListener('input', loadBookings);
}

/* login */
async function login(){
  const email = $('email').value.trim();
  const pass = $('password').value;
  if(!email || !pass) { $('loginMsg').textContent='Ingresa correo y contraseña'; return; }
  $('loginMsg').textContent = 'Iniciando...';
  try{
    await auth.signInWithEmailAndPassword(email, pass);
    $('loginMsg').textContent = '';
  }catch(e){
    console.error(e); $('loginMsg').textContent = 'Error: ' + (e.message || 'no se pudo iniciar sesión');
  }
}

/* bookings */
const state = { bookings: [] };
function loadBookings(){
  database.ref('bookings').on('value', snap => {
    state.bookings = snap.val() ? Object.values(snap.val()) : [];
    renderBookings();
  });
}

function renderBookings(){
  const q = $('search').value.trim().toLowerCase();
  const filtered = q ? state.bookings.filter(b => (b.name||'').toLowerCase().includes(q) || (b.phone||'').includes(q) || (b.service||'').toLowerCase().includes(q)) : state.bookings;
  const tbody = $('tbody');
  if(!filtered.length) { tbody.innerHTML = '<tr><td colspan="7" style="padding:18px;color:var(--muted)">No hay reservaciones</td></tr>'; return; }
  tbody.innerHTML = filtered.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt)).map(b => {
    const date = new Date(b.date + 'T' + (b.time||'00:00'));
    const ds = date.toLocaleDateString('es-MX',{day:'2-digit',month:'short'});
    return `<tr>
      <td>${ds}</td>
      <td>${b.time||'-'}</td>
      <td>${escapeHtml(b.name)}<div style="color:var(--muted);font-size:0.9rem">${escapeHtml(b.phone)}</div></td>
      <td>${escapeHtml(b.service)}</td>
      <td>$${b.price}</td>
      <td>${b.status==='confirmed'?'<strong style="color:#10b981">Confirmada</strong>':'<strong style="color:#f43f5e">Cancelada</strong>'}</td>
      <td>${b.status==='confirmed'?`<button class="btn" data-id="${b.id}" data-action="cancel">Cancelar</button>`:`<button class="btn" data-id="${b.id}" data-action="delete">Eliminar</button>`} <a class="btn" href="recibo.html?id=${encodeURIComponent(b.id)}" target="_blank">Recibo</a></td>
    </tr>`;
  }).join('');
  document.querySelectorAll('button[data-action]').forEach(btn=>{
    btn.addEventListener('click', async ()=> {
      const id = btn.dataset.id, action = btn.dataset.action;
      if(action==='cancel'){ if(!confirm('Cancelar reservación?')) return; await updateBooking(id,{status:'cancelled'}); }
      if(action==='delete'){ if(!confirm('Eliminar permanentemente?')) return; await deleteBooking(id); }
    });
  });
  renderStats();
}

async function updateBooking(id, patch){
  try{ await database.ref('bookings/' + id).update(patch); alert('Actualizado'); }catch(e){ alert('Error'); console.error(e); }
}
async function deleteBooking(id){
  try{ await database.ref('bookings/' + id).remove(); alert('Eliminada'); }catch(e){ alert('Error'); console.error(e); }
}

function renderStats(){
  const total = state.bookings.filter(b=>b.status==='confirmed').length;
  const today = new Date().toISOString().split('T')[0];
  const todayCount = state.bookings.filter(b=>b.date===today && b.status==='confirmed').length;
  const revenue = state.bookings.filter(b=>b.status==='confirmed').reduce((s,b)=> s + Number(b.price||0), 0);
  $('statTotal').textContent = total; $('statToday').textContent = todayCount; $('statRevenue').textContent = '$' + revenue.toLocaleString();
}

function escapeHtml(s){ const d=document.createElement('div'); d.textContent = s; return d.innerHTML; }

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
